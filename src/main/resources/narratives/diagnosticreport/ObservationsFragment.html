<!--/*-->
<html>
<head>
    <link rel="stylesheet" type="text/css" href="narrative.css"/>
</head>
<body>
<!--*/-->
<th:block th:fragment="observations (items,level)">
    <th:block th:each="result,rowStat : ${items}">
        <tr th:class="'level_'+${level} + ' ' + (${not result.resource.hasMember.empty }? 'title' : (${rowStat.odd}? 'hapiTableOfValuesRowOdd' : 'hapiTableOfValuesRowEven'))" class="hapiTableOfValuesRowOdd">
            <td class="label">
                <th:block th:if="${not result.resource.code.textElement.empty}"
                          th:text="${result.resource.code.textElement.value}"/>
                <th:block
                        th:if="${result.resource.code.textElement.empty} and ${not #lists.isEmpty(result.resource.code.coding)} and ${not result.resource.code.coding[0].empty} and ${not result.resource.code.coding[0].displayElement.empty}"
                        th:text="${result.resource.code.coding[0].display}"/>
                <th:block
                        th:if="${result.resource.code.textElement.empty} and ${not #lists.isEmpty(result.resource.code.coding)} and ${not result.resource.code.coding[0].empty} and ${result.resource.code.coding[0].displayElement.empty}"
                        th:text="'?'"/>
                <!--/*--> Hb <!--*/-->
            </td>
            <td>
                <!-- quantity -->
                <th:block th:if="${result.resource.hasValueQuantity} and ${result.resource.valueQuantity.hasComparatorElement}" th:text="${result.resource.valueQuantity.comparatorElement.code}"/>
                <th:block th:if="${result.resource.hasValueQuantity} and ${result.resource.valueQuantity.hasValueElement}" th:text="${result.resource.valueQuantity.valueElement.valueAsString}"/>
                <th:block th:if="${result.resource.hasValueQuantity} and ${result.resource.valueQuantity.hasUnit}" th:text="${result.resource.valueQuantity.unit}"/>
                <th:block th:if="${result.resource.hasValueQuantity} and ${not result.resource.valueQuantity.hasUnit} and ${result.resource.valueQuantity.hasCode}" th:text="${result.resource.valueQuantity.code}"/>
                <!-- string -->
                <th:block th:if="${result.resource.hasValueStringType}" th:text="${result.resource.valueStringType} + ' '"/>
                <!-- codeable concept -->
                <th:block th:if="${result.resource.hasValueCodeableConcept} and ${${result.resource.valueCodeableConcept.hasCoding}}">
                    <th:block th:if="${result.resource.valueCodeableConcept.codingFirstRep.hasDisplay}" th:text="${result.resource.valueCodeableConcept.codingFirstRep.display} + ' '"/>
                    <th:block th:if="${result.resource.valueCodeableConcept.codingFirstRep.hasSystem}" th:text="'(' + ${result.resource.valueCodeableConcept.codingFirstRep.system} + ') '"/>
                    <th:block th:if="${result.resource.valueCodeableConcept.codingFirstRep.hasCode}" th:text="'(' + ${result.resource.valueCodeableConcept.codingFirstRep.code} + ') '"/>
                </th:block>
                <!-- boolean -->
                <th:block th:if="${result.resource.hasValueBooleanType}" th:text="${result.resource.valueBooleanType.valueAsString}"/>
                <!-- date time -->
                <th:block th:if="${result.resource.hasValueDateTimeType}" th:text="${#dates.format(result.resource.valueDateTimeType.value,'dd MMMM yyyy hh:mm:ss')}"/>
                <!-- integer -->
                <th:block th:if="${result.resource.hasValueIntegerType}" th:text="${result.resource.valueIntegerType.valueAsString}"/>
                <!-- period -->
                <th:block th:if="${result.resource.hasValuePeriod}">
                    <span th:if="${result.resource.effectivePeriod.hasStartElement}"
                          th:text="${#dates.format(result.resource.valuePeriod.startElement.value,'dd MMMM yyyy')}">...</span>
                    -
                    <span
                            th:if="${result.resource.effectivePeriod.hasEndElement}"
                            th:text="${#dates.format(result.resource.valuePeriod.endElement.value,'dd MMMM yyyy')}">...</span>
                </th:block>
                <!-- range -->
                <th:block th:if="${result.resource.hasValueRange}">
                    <th:block th:if="${not result.resource.valueRange.low.empty} and ${not result.resource.valueRange.high.empty}">
                        <th:block th:narrative="${result.resource.valueRange.low}">--</th:block>&nbsp;-&nbsp;<th:block th:narrative="${result.resource.valueRange.high}">--</th:block>
                    </th:block>
                    <th:block th:if="${result.resource.valueRange.low.empty} and ${not result.resource.valueRange.high.empty}">
                        &lt;&nbsp;<th:block th:narrative="${result.resource.valueRange.high}"></th:block>
                    </th:block>
                    <th:block th:if="${not result.resource.valueRange.low.empty} and ${result.resource.valueRange.high.empty}">
                        &gt;&nbsp;<th:block th:narrative="${result.resource.valueRange.low}"></th:block>
                    </th:block>
                    <th:block th:if="${result.resource.valueRange.hasTextElement}">
                        <th:block th:narrative="${result.resource.valueRange.textElement}"></th:block>
                    </th:block>
                </th:block>
                <!-- ratio -->
                <th:block th:if="${result.resource.hasValueRatio}">
                    <th:block th:if="${result.resource.valueRatio.hasNumerator}">
                        <th:block th:if="${result.resource.numerator.hasComparatorElement}" th:text="${result.resource.numerator.comparatorElement.code}"/>
                        <th:block th:if="${result.resource.numerator.hasValueElement}" th:text="${result.resource.numerator.valueElement.valueAsString}"/>
                        <th:block th:if="${result.resource.numerator.hasUnit}" th:text="${result.resource.numerator.unit}"/>
                        <th:block th:if="${not result.resource.numerator.hasUnit} and ${result.resource.numerator.hasCode}" th:text="${result.resource.numerator.code}"/>
                    </th:block>
                    /
                    <th:block th:if="${result.resource.valueRatio.hasDenominator}">
                        <th:block th:if="${result.resource.denominator.hasComparatorElement}" th:text="${result.resource.denominator.comparatorElement.code}"/>
                        <th:block th:if="${result.resource.denominator.hasValueElement}" th:text="${result.resource.denominator.valueElement.valueAsString}"/>
                        <th:block th:if="${result.resource.denominator.hasUnit}" th:text="${result.resource.denominator.unit}"/>
                        <th:block th:if="${not result.resource.denominator.hasUnit} and ${result.resource.denominator.hasCode}" th:text="${result.resource.denominator.code}"/>
                    </th:block>
                </th:block>
                <!-- sample data, what is this in a lab context? -->
                <!-- time -->
                <th:block th:if="${result.resource.hasValueTimeType}" th:text="${result.resource.valueTimeType.valueAsString}"/>
            </td>
            <td>
                <th:block
                        th:if="${not result.resource.interpretation.empty} and ${not result.resource.interpretation[0].textElement.empty}"
                        th:text="${result.resource.interpretation[0].text}"/>
                <th:block
                        th:if="${not result.resource.interpretation.empty} and ${result.resource.interpretation[0].textElement.empty} and ${not result.resource.interpretation[0].coding.empty} and ${not result.resource.interpretation[0].coding[0].displayElement.empty}"
                        th:text="${result.resource.interpretation[0].coding[0].display}"/>
                <!--/*--> N <!--*/-->
            </td>
            <td>
                <th:block th:each="ref,rowStat : ${result.resource.referenceRange}">
                    <th:block th:if="${not ref.low.empty} and ${not ref.high.empty}">
                        <th:block th:narrative="${ref.low}">--</th:block>&nbsp;-&nbsp;<th:block th:narrative="${ref.high}">--</th:block>
                    </th:block>
                    <th:block th:if="${ref.low.empty} and ${not ref.high.empty}">
                        &lt;&nbsp;<th:block th:narrative="${ref.high}"></th:block>
                    </th:block>
                    <th:block th:if="${not ref.low.empty} and ${ref.high.empty}">
                        &gt;&nbsp;<th:block th:narrative="${ref.low}"></th:block>
                    </th:block>
                    <th:block th:if="${ref.hasTextElement}">
                        <th:block th:narrative="${ref.textElement}"></th:block>
                    </th:block>
                </th:block>
            </td>
            <td>
                <th:block th:unless="${result.resource.hasHasMember}" th:text="${result.resource.statusElement.value}">final</th:block>
            </td>
            <th:block th:if="${result.resource.hasCategory} or ${result.resource.hasEffectiveDateTimeType} or ${result.resource.hasEffectivePeriod} or ${result.resource.hasEffectiveInstantType} or ${result.resource.hasIssuedElement} or ${result.resource.hasDataAbsentReason} or ${result.resource.hasBodySite} or ${result.resource.hasComponent}">
                <td class="toggable" onclick="this.classList.toggle('displayed');  this.parentElement.nextElementSibling.classList.toggle('hidden');">
                    <div>
                        <span class="inline clicktoshow">+</span><span class="inline clicktohide">-</span>
                    </div>
                </td>
            </th:block>
            <th:block th:unless="${result.resource.hasCategory} or ${result.resource.hasEffectiveDateTimeType} or ${result.resource.hasEffectivePeriod} or ${result.resource.hasEffectiveInstantType} or ${result.resource.hasIssuedElement} or ${result.resource.hasDataAbsentReason} or ${result.resource.hasBodySite} or ${result.resource.hasComponent}">
                <td>
                </td>
            </th:block>
        </tr>
        <tr th:class="'hidden'" th:if="${result.resource.hasCategory} or ${result.resource.hasEffectiveDateTimeType} or ${result.resource.hasEffectivePeriod} or ${result.resource.hasEffectiveInstantType} or ${result.resource.hasIssuedElement} or ${result.resource.hasDataAbsentReason} or ${result.resource.hasBodySite} or ${result.resource.hasComponent}">
            <td colspan="6">
               <table>
                    <tbody>
                        <tr th:if="${result.resource.hasLanguage}">
                            <td>Language</td>
                            <td th:text="${result.resource.language}"/>
                        </tr>
                        <tr th:if="${result.resource.hasCategory}">
                            <td>Category</td>
                            <td th:text="${result.resource.category}"/>
                        </tr>
                        <tr th:if="${result.resource.hasEffectiveDateTimeType}">
                            <td>Effective date (datetime)</td>
                            <td th:text="${#dates.format(result.resource.effectiveDateTimeType.value,'dd MMMM yyyy hh:mm:ss')}"/>
                        </tr>
                        <tr th:if="${result.resource.hasEffectivePeriod}">
                            <td>Effective date (period)</td>
                            <td><span th:if="${result.resource.effectivePeriod.hasStartElement}"
                                    th:text="${#dates.format(result.resource.effectivePeriod.startElement.value,'dd MMMM yyyy')}">...</span>
                                -
                                <span
                                    th:if="${result.resource.effectivePeriod.hasEndElement}"
                                    th:text="${#dates.format(result.resource.effectivePeriod.endElement.value,'dd MMMM yyyy')}">...</span></td>
                        </tr>
                        <!-- will effective timing ever occur in context of lab results? -->
                        <!--tr th:if="${result.resource.hasEffectiveTiming}">
                            <td>Effective date</td>
                            <td>(effective timing)</td>
                        </tr-->
                        <tr th:if="${result.resource.hasEffectiveInstantType}">
                            <td>Effective date (instant)</td>
                            <td th:text="${#dates.format(result.resource.effectiveInstantType.value,'dd MMMM yyyy hh:mm:ss')}"/>
                        </tr>
                        <tr th:if="${result.resource.hasIssuedElement}">
                            <td>Issued date</td>
                            <td th:text="${#dates.format(result.resource.issuedElement.value,'dd MMMM yyyy hh:mm:ss')}"/>
                        </tr>
                        <tr th:if="${result.resource.hasDataAbsentReason}">
                            <td>Data absent reason</td>
                            <td th:include="@{inlinecode} :: inlinecode (${result.resource.dataAbsentReason})"></td>
                        </tr>
                        <tr th:if="${result.resource.hasBodySite}">
                            <td>Body site</td>
                            <td th:include="@{inlinecode} :: inlinecode (${result.resource.bodySite})"></td>
                        </tr>
                        <!-- derivedFrom shows which other observation(s) this observation was derived from,
                             is this usefull clinical information to show in the visualizer? How do we show the other observations this has been derived from?
                             Include all information of that observation -again- in a collapsible sub-table? The screen will get very busy imo. -->
                        <!--th:block th:if="${result.resource.hasDerivedFrom}" th:each="derivedFrom : ${result.resource.hasDerivedFrom}">
                            <tr>
                                <td>Derived from</td>
                                <td>(derived from)</td>
                            </tr>
                        </th:block-->
                        <tr th:if="${result.resource.hasComponent}" th:each="component : ${result.resource.component}">
                            <td>Component</td>
                            <td>
                                <th:block th:if="${not component.hasValueQuanity} and ${not component.hasValueCodeableConcept} and ${not component.hasValueStringType}" th:text="'(component without quantity, code or string?)'"/>

                                <th:block th:if="${component.hasValueQuantity} and ${not component.valueQuantity.comparatorElement.empty}" th:text="${component.valueQuantity.comparatorElement.value}"/>
                                <th:block th:if="${component.hasValueQuantity} and ${not component.valueQuantity.valueElement.empty}" th:text="${component.valueQuantity.valueElement.valueAsString}"/>
                                <th:block th:if="${component.hasValueQuantity} and ${not component.valueQuantity.unitElement.empty}" th:text="${component.valueQuantity.unitElement.value}"/>
                                <th:block th:if="${component.hasValueStringType}" th:text="${component.valueStringType} + ' '"/>
                                <th:block th:if="${component.hasValueCodeableConcept} and ${${component.valueCodeableConcept.hasCoding}}">
                                    <th:block th:if="${component.valueCodeableConcept.codingFirstRep.hasDisplay}" th:text="${component.valueCodeableConcept.codingFirstRep.display} + ' '"/>
                                    <th:block th:if="${component.valueCodeableConcept.codingFirstRep.hasSystem}" th:text="'(' + ${component.valueCodeableConcept.codingFirstRep.system} + ') '"/>
                                    <th:block th:if="${component.valueCodeableConcept.codingFirstRep.hasCode}" th:text="'(' + ${component.valueCodeableConcept.codingFirstRep.code} + ') '"/>
                                </th:block>
                            </td>
                        </tr>
                    </tbody>
               </table>
            </td>
        </tr>
        <tr th:replace="@{observations} :: observations (items=${result.resource.hasMember},level=${level}+1)"></tr>
        <th:block th:if="${result.resource.hasNote}" th:each="note : ${result.resource.note}">
            <tr th:class="${rowStat.odd}? 'hapiTableOfValuesRowOdd' : 'hapiTableOfValuesRowEven'"
                class="hapiTableOfValuesRowOdd">
                <td th:text="${note.text}" colspan="6">This is a comment</td>
            </tr>
        </th:block>
    </th:block>
</th:block>
<!--/*-->
</body>
</html>
<!--*/-->
